<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="end" style="margin-right: 10px;">
      <div style="text-align: right; color: white;">
        <div style="font-weight: bold; font-size: 1em;">
          Bed {{ patient.selectedBedId || '?' }}
        </div>
        <div *ngIf="patient.current.naam" style="font-size: 0.7em; opacity: 0.8; margin-top: -2px;">
          {{ patient.current.naam }}
        </div>
      </div>
    </ion-buttons>
    <ion-title>Ventilatie</ion-title>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment mode="ios" [(ngModel)]="mode" (ionChange)="segmentChanged($event)" class="custom-toolbar-segment">
      <ion-segment-button value="controlled">
        <ion-label>Gecontroleerd</ion-label>
      </ion-segment-button>
      <ion-segment-button value="spontaneous">
        <ion-label>Spontaan</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <ion-card class="data-card" *ngIf="patient.current.ibw" style="margin-bottom: 20px;">
    <ion-card-header>
      <ion-card-title style="font-size: 1.1em;">
        Lung Protective Targets ({{ patient.current.ibw | number:'1.0-0' }} kg)
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6" style="text-align: center; border-right: 1px solid #444;">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">6 ml/kg</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #28a745;">{{ 6 * patient.current.ibw | number:'1.0-0' }} ml</div>
          </ion-col>
          <ion-col size="6" style="text-align: center;">
            <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">8 ml/kg</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #ffc107;">{{ 8 * patient.current.ibw | number:'1.0-0' }} ml</div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <div *ngIf="mode === 'controlled'">
    <ion-card>

     <ion-card-header>
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <ion-card-title>Mechanica</ion-card-title>

    <ion-button fill="clear" size="small" (click)="toonInfo()" style="--color: #00796B; font-weight: bold;">
      Uitleg
      <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
    </ion-button>
  </div>
</ion-card-header>

      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-input class="custom-green-input" label="Vt (ml)" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputVt"></ion-input>
            </ion-col>
            <ion-col>
              <ion-input class="custom-green-input" label="RR (/min)" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputRR"></ion-input>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col>
              <ion-input class="custom-green-input" label="PEEP" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputPeep"></ion-input>
            </ion-col>
            <ion-col>
              <ion-input class="custom-green-input" label="P-Plat" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputPplat"></ion-input>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col>
              <ion-input class="custom-green-input" label="P-Piek" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputPpiek"></ion-input>
            </ion-col>
            <ion-col>
              <ion-input class="custom-green-input" label="Resistance (R)" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputResistance" placeholder="Optioneel"></ion-input>
            </ion-col>
          </ion-row>
          <ion-row>
             <ion-col size="6">
               <ion-input class="custom-green-input" label="PaCO₂" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                 [(ngModel)]="inputPaCO2" placeholder="kPa"></ion-input>
             </ion-col>
             <ion-col size="6">
               <ion-input class="custom-green-input" label="EtCO₂ " label-placement="floating" fill="outline" type="number" inputmode="decimal"
                 [(ngModel)]="inputPeCO2" placeholder="kPa"></ion-input>
             </ion-col>
          </ion-row>
        </ion-grid>

        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-button expand="block" class="teal-btn" (click)="berekenControlled()">Analyseer</ion-button>
            </ion-col>
            <ion-col size="4">
              <ion-button expand="block" color="medium" fill="outline" (click)="resetVelden()">Reset</ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="resDrivingPressure || resCdyn || resVdVt" class="result-card">
       <ion-card-header>
         <ion-card-title>Resultaten</ion-card-title>
       </ion-card-header>
       <ion-list lines="full">

         <ion-item *ngIf="resVtPerKg">
           <ion-label>Huidig Volume / kg</ion-label>
           <ion-badge slot="end" [color]="resVtPerKg > 8 ? 'warning' : 'success'">
             {{ resVtPerKg | number:'1.1-1' }} ml/kg
           </ion-badge>
         </ion-item>

         <ion-item *ngIf="resDrivingPressure">
            <ion-label>
              <h2>Driving Pressure</h2>
              <p>Pplat - PEEP (< 15)</p>
            </ion-label>
            <ion-badge slot="end" [color]="dpKleur">
              {{ resDrivingPressure | number:'1.0-0' }}
            </ion-badge>
         </ion-item>

         <ion-item *ngIf="resCstat">
           <ion-label>
             <h2>C-Statisch</h2>
             <p>ml / cmH₂O</p>
           </ion-label>
           <ion-note slot="end" style="font-weight:bold;">
             {{ resCstat | number:'1.0-0' }}
           </ion-note>
         </ion-item>

         <ion-item *ngIf="resCdyn">
           <ion-label>
             <h2>C-Dynamisch</h2>
             <p>ml / cmH₂O</p>
           </ion-label>
           <ion-note slot="end" style="font-weight:bold;">
             {{ resCdyn | number:'1.0-0' }}
           </ion-note>
         </ion-item>

         <ion-item *ngIf="resTimeConstant">
            <ion-label>
              <h2>Tijdconstante (RC)</h2>
              <p>Min. Exp. Tijd (3x)</p>
              <p style="font-size: 0.75em; color: #888; font-style: italic; margin-top: 4px;">
  Tip! Ga naar tab Hamilton voor betekenis RCexp
              </p>
            </ion-label>
            <ion-note slot="end" color="secondary" style="text-align:right;">
               <strong>{{ resTimeConstant | number:'1.2-2' }} s</strong><br>
               <span style="font-size:0.8em;">3x = {{ resTimeConstant * 3 | number:'1.1-1' }} s</span>
            </ion-note>
         </ion-item>

         <ion-item *ngIf="resVdVt">
            <ion-label>
              <h2>Dode Ruimte (Vd/Vt)</h2>
              <p>Target < 40%</p>
            </ion-label>
            <ion-badge slot="end" [color]="resVdVt > 0.4 ? 'warning' : 'success'">
               {{ resVdVt | percent:'1.0-0' }}
            </ion-badge>
         </ion-item>

         <ion-item *ngIf="resMechPower">
            <ion-label>
              <h2>Mechanical Power</h2>
              <p>Target < 17 J</p>
            </ion-label>
            <ion-badge slot="end" [color]="mpKleur">
              {{ resMechPower | number:'1.1-1' }} J
            </ion-badge>
         </ion-item>
       </ion-list>
    </ion-card>
  </div>


  <div *ngIf="mode === 'spontaneous'">
    <ion-card>

      <ion-card-header>
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <ion-card-title>Pressure Support / Weaning</ion-card-title>

    <ion-button fill="clear" size="small" (click)="toonInfo()" style="--color: #00796B; font-weight: bold;">
      Uitleg
      <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
    </ion-button>
  </div>
</ion-card-header>

      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-input class="custom-green-input" label="P-Peak" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputSponPpeak"></ion-input>
            </ion-col>
            <ion-col>
              <ion-input class="custom-green-input" label="PEEP-tot" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputSponPeepTot"></ion-input>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col>
              <ion-input class="custom-green-input" label="P-nadir (negatief!)" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                [(ngModel)]="inputSponPnadir" placeholder="-4.0"></ion-input>
            </ion-col>
          </ion-row>
          <ion-row>
             <ion-col size="6">
               <ion-input class="custom-green-input" label="PaCO₂" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                 [(ngModel)]="inputPaCO2" placeholder="kPa"></ion-input>
             </ion-col>
             <ion-col size="6">
               <ion-input class="custom-green-input" label="EtCO₂" label-placement="floating" fill="outline" type="number" inputmode="decimal"
                 [(ngModel)]="inputPeCO2" placeholder="kPa"></ion-input>
             </ion-col>
          </ion-row>
        </ion-grid>

        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-button expand="block" class="teal-btn"  (click)="berekenSpontaneous()">Bereken Effort</ion-button>
            </ion-col>
            <ion-col size="4">
              <ion-button expand="block" color="medium" fill="outline" (click)="resetVelden()">Reset</ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="resPmus || resVdVt" style="border-left: 5px solid #3880ff;">
      <ion-card-header>
        <ion-card-title>Resultaten (VentICalc)</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">

          <div *ngIf="resPmus">
            <ion-item>
              <ion-label>Occlusion Pressure (&Delta;Pocc)</ion-label>
              <ion-text slot="end">{{ resPocc | number:'1.1-1' }}</ion-text>
            </ion-item>

            <ion-item>
              <ion-label>
                <h2>Predicted Pmus</h2>
                <p>Spierkracht (Doel: < 10)</p>
              </ion-label>
              <ion-badge slot="end" [color]="pmusKleur" style="font-size:1em;">
                {{ resPmus | number:'1.1-1' }}
              </ion-badge>
            </ion-item>

            <ion-item>
              <ion-label>
                <h2>Transpulmonaal (Ptp)</h2>
                <p>Doel: < 25</p>
              </ion-label>
              <ion-badge slot="end" [color]="ptpKleur" style="font-size:1em;">
                {{ resPtp | number:'1.1-1' }}
              </ion-badge>
            </ion-item>
          </div>

          <ion-item *ngIf="resVdVt">
            <ion-label>
              <h2>Dode Ruimte (Vd/Vt)</h2>
              <p>Target < 40%</p>
            </ion-label>
            <ion-badge slot="end" [color]="resVdVt > 0.4 ? 'warning' : 'success'">
               {{ resVdVt | percent:'1.0-0' }}
            </ion-badge>
         </ion-item>

        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
