<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button style="color: var(--med-teal);"></ion-menu-button>
    </ion-buttons>

    <ion-title>
      Hamilton IntelliVent-ASV
    </ion-title>

    <ion-buttons slot="end" style="margin-right: 10px;">
      <div style="text-align: right; color: white;">
        <div style="font-weight: bold; font-size: 1em;">
          Bed {{ patient.selectedBedId || '?' }}
        </div>
        <div *ngIf="patient.current?.naam" style="font-size: 0.7em; opacity: 0.8; margin-top: -2px;">
          {{ patient.current.naam }}
        </div>
      </div>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <ion-alert
    [isOpen]="isAlertOpen"
    header="Protocol Afwijking"
    message="Afwijken van deze afspraken altijd in overleg met een intensivist of Ventilation Practitioner."
    [buttons]="alertButtons"
    (didDismiss)="setOpen(false)">
  </ion-alert>

  <ion-card class="data-card" style="border-left: 5px solid #ffca28;">
    <ion-card-header>
       <ion-card-title>
         Werk Afspraken
       </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list lines="none">
        <ion-item *ngFor="let afspraak of afspraken">
          <ion-checkbox slot="start" [(ngModel)]="afspraak.checked"></ion-checkbox>
          <ion-label class="ion-text-wrap" [style.text-decoration]="afspraak.checked ? 'line-through' : 'none'" [style.opacity]="afspraak.checked ? '0.5' : '1'">
            {{ afspraak.text }}
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="analysis" [color]="analysis.color" style="margin-top: 20px;">
    <ion-card-header>
      <ion-row>
        <ion-col><small>Restrictief</small></ion-col>
        <ion-col class="ion-text-end"><small>Obstructief</small></ion-col>
      </ion-row>
      <ion-card-title class="ion-text-center" style="font-size: 1.8em; font-weight: bold;">
        RC<sub>exp</sub>: {{ currentRC | number:'1.2-2' }} s
      </ion-card-title>
      <ion-card-subtitle class="ion-text-center" style="color: rgba(255,255,255,0.8);">
        {{ analysis.description }}
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content class="ion-text-center">
      <ion-range min="0.1" max="2.0" step="0.05" [(ngModel)]="currentRC" (ionChange)="updateAnalysis()" color="dark">
        <ion-icon slot="start" name="pulse-outline"></ion-icon>
        <ion-icon slot="end" name="reorder-two-outline"></ion-icon>
      </ion-range>

      <div class="ion-padding-top">
        <h2 style="font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">{{ analysis.type }}</h2>

        <div style="margin: 0 auto; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); max-width: 250px;">
           <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">Ideale Frequentie (Otis)</p>
           <h1 style="margin: 5px 0 0 0; font-size: 3.5em; font-weight: bold;">
             {{ idealFreq }} <small style="font-size: 0.4em;">b/min</small>
           </h1>
        </div>

        <p style="margin-top: 15px;">Minimale T<sub>exp</sub> (3x RC): <strong>{{ analysis.tExpRequired | number:'1.2-2' }}s</strong></p>

        <div style="margin-top: 15px; background: white; padding: 8px; border-radius: 8px; display: block;">
            <img [src]="'assets/images/flow_' + analysis.imageTag + '.png'"
                 alt="Flow curve"
                 style="width: 100%; height: auto; max-height: 300px; object-fit: contain; display: block; margin: 0 auto;">
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-accordion-group style="margin-bottom: 50px; margin-top: 20px;">

    <ion-accordion value="otis">
          <ion-item slot="header" style="--background: #00695c; --color: #ffffff;">
        <ion-label>Otis Formule & Fysiologie</ion-label>
      </ion-item>
          <div class="ion-padding" slot="content" style="background: #0c0707ff; color: white;">
            <img src="assets/images/otis_grafiek.png" class="center-img" style="border-radius: 8px; margin-bottom: 15px;" alt="Otis Curve">
            <p style="font-family: serif; font-style: italic; font-size: 1.1em; text-align: center; margin: 15px 0;">
              f = [√(1 + 2a · RC · (MinVol / Vd)) - 1] / (a · RC)
            </p>
            <h3 style="color: #3880ff; font-weight: bold;">Legenda Formule:</h3>
            <ul style="font-size: 0.9em; padding-left: 20px;">
              <li><strong>f:</strong> RR (Ademhalingsfrequentie)</li>
              <li><strong>RC:</strong> Tijdsconstante (Weerstand × Compliantie)</li>
              <li><strong>MinVol:</strong> Minuutvolume</li>
              <li><strong>Vd:</strong> Dode ruimte volume</li>
              <li><strong>ɑ:</strong> Constante (0.33)</li>
            </ul>
            <h3 style="color: #3880ff; font-weight: bold; margin-top: 15px;">Klinische Toepassing:</h3>
            <p style="font-size: 0.9em;">De Hamilton zoekt de frequentie waarbij de <strong>ademarbeid</strong> minimaal is.</p>
          </div>
        </ion-accordion>



<ion-accordion value="mead" style="margin-top: 10px;">
          <ion-item slot="header" style="--background: #00695c; --color: #ffffff;">
        <ion-label>Mead Formule (minimale kracht)</ion-label>
      </ion-item>
          <div class="ion-padding" slot="content" style="background: #0c0707ff; color: white;">
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #000;">
              <p style="margin: 0; font-size: 0.8em; color: #666; font-weight: bold;">MEAD EQUATION</p>
              <h2 style="font-family: serif; font-style: italic; font-size: 1.6em; margin: 10px 0;">
                f = (MVA/VD)<sup>1/3</sup> · (2&pi;RC)<sup>-2/3</sup>
              </h2>
            </div>

            <h3 style="color: #3880ff; font-weight: bold;">Klinische Voordelen:</h3>
            <ul style="font-size: 0.9em; line-height: 1.5; color: #ccc;">
              <li><strong>Lagere Mechanical Power</strong></li>
              <li><strong>Lagere driving pressure (∆P)</strong></li>
              <li><strong>Minimale inspiratoire druk</strong></li>
              <li><strong>Lagere plateau-druk</strong></li>
            </ul>

            <div style="background: rgba(45, 211, 111, 0.2); padding: 10px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #2dd36f;">
               <p style="font-size: 0.9em; margin: 0;">
                 <strong>Longprotectie:</strong> Hierdoor ontstaat een betere bescherming met minder risico op <strong>volutrauma</strong> en <strong>barotrauma</strong>.
               </p>
            </div>
          </div>
        </ion-accordion>

         <ion-accordion value="physics" style="margin-top: 10px;">
          <ion-item slot="header" style="--background: #00695c; --color: #ffffff;">
        <ion-label>Fysiologie & Longmechanica</ion-label>
      </ion-item>
          <div class="ion-padding" slot="content" style="background: #0c0707ff; color: white;">

            <h3 style="color: #ffc409; font-weight: bold; border-bottom: 1px solid #333;">De RC<sub>exp</sub> Logica</h3>
            <p style="font-size: 0.9em; line-height: 1.4;">
              RC<sub>exp</sub> zegt iets over hoe snel de long kan uitademen.
            </p>
            <ul style="font-size: 0.85em; color: #ccc;">
              <li><strong>Elke RC<sub>exp</sub>:</strong> Ongeveer 63% van het VT dat is uitgeademd.</li>
              <li><strong>Na 3x RC<sub>exp</sub>:</strong> Is 95% uitgeademd; dit gebruikt IntelliVent-ASV als minimum expiratie.</li>
            </ul>

            <div style="background: rgba(56, 128, 255, 0.2); padding: 10px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3880ff;">
              <p style="font-size: 0.85em; margin: 0;">
                <strong>Veiligheid:</strong> Hierdoor voorkomt het systeem <strong>air trapping</strong> en <strong>auto-PEEP</strong>, en past het automatisch de ademfrequentie aan.
              </p>
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; color: #000;">
              <h2 style="font-family: serif; font-size: 1.1em; margin: 0;">RC<sub>exp</sub> (s) = Compliance × Resistance</h2>
              <p style="font-size: 0.7em; margin: 0;">(mL/cmH<sub>2</sub>O) × (cmH<sub>2</sub>O.s/ml)</p>
            </div>

            <p style="font-size: 0.85em; color: #ccc; margin-bottom: 15px;">
              De tijdconstante (RC) geeft de snelheid weer waarmee het systeem zijn volume verandert in reactie op een verandering in de toegepaste druk.
            </p>

            <ion-grid style="--ion-grid-padding: 0;">
              <ion-row style="font-weight: bold; border-bottom: 1px solid #444; font-size: 0.75em; color: #aaa;">
                <ion-col size="4">Type</ion-col>
                <ion-col size="4">C<sub>stat</sub> / R<sub>insp</sub></ion-col>
                <ion-col size="4">Ziekte</ion-col>
              </ion-row>
              <ion-row style="font-size: 0.75em; color: #2dd36f; padding: 8px 0; border-bottom: 1px solid #222;">
                <ion-col size="4">Normaal<br><small>0.6-0.9s</small></ion-col>
                <ion-col size="4">60 / 10</ion-col>
                <ion-col size="4">Gezond</ion-col>
              </ion-row>
              <ion-row style="font-size: 0.75em; color: #3171e0; padding: 8px 0; border-bottom: 1px solid #222;">
                <ion-col size="4">Restrictief<br><small>< 0.6s</small></ion-col>
                <ion-col size="4">22 / 10</ion-col>
                <ion-col size="4">ARDS, Atlectase</ion-col>
              </ion-row>
              <ion-row style="font-size: 0.75em; color: #ffc409; padding: 8px 0;">
                <ion-col size="4">Obstructief<br><small>> 0.9s</small></ion-col>
                <ion-col size="4">70 / 30</ion-col>
                <ion-col size="4">COPD, astma, bronchospasmes</ion-col>
              </ion-row>
            </ion-grid>
          </div>
        </ion-accordion>


  </ion-accordion-group>
<ion-card button (click)="openPVWizard()" style="background: linear-gradient(135deg, #00796B, #004D40);">
  <ion-card-content style="display: flex; align-items: center; color: white;">
    <ion-icon name="analytics-outline" style="font-size: 30px; margin-right: 15px;"></ion-icon>
    <div>
      <h2 style="margin: 0; font-weight: bold; font-size: 1.2em;">PV Tool Assistent</h2>
      <p style="margin: 0; opacity: 0.9;">Hysterese & Recruitment Protocol</p>
    </div>
    <ion-icon name="chevron-forward" slot="end" style="margin-left: auto;"></ion-icon>
  </ion-card-content>
</ion-card>
</ion-content>
